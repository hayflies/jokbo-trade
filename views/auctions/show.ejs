<%- include('../partials/header', { title: auction.title }) %>
<%
  const downloadAllowed = typeof allowDownload === 'undefined' ? false : allowDownload;
  const sellerView = typeof isSeller === 'undefined' ? false : isSeller;
  const winnerView = typeof isWinner === 'undefined' ? false : isWinner;
  const bidAllowed = typeof canBid === 'undefined' ? false : canBid;
  const rateAllowed = typeof canRate === 'undefined' ? false : canRate;
  const bidLogList = typeof bidLogs !== 'undefined' && Array.isArray(bidLogs) ? bidLogs : [];
  const activeUser = typeof currentUser === 'undefined' ? null : currentUser;
  const bidderView = typeof userHasBid === 'undefined' ? false : userHasBid;
  const existingReview = typeof userReview !== 'undefined' && userReview ? userReview : null;
%>
<section
  class="card"
  data-auction-detail
  data-auction-id="<%= auction.id %>"
  data-current-user-id="<%= activeUser ? activeUser.id : '' %>"
  data-seller-id="<%= auction.sellerId %>"
  data-user-has-bid="<%= bidderView ? 'true' : 'false' %>"
>
  <header class="card-header">
    <h2><%= auction.title %></h2>
    <p class="muted">판매자 닉네임: <%= auction.sellerNickname %></p>
    <span class="status-badge <%= auction.status === 'CLOSED' ? 'status-closed' : 'status-open' %>">
      <%= auction.status === 'CLOSED' ? '종료됨' : '진행 중' %>
    </span>
  </header>
  <div class="auction-meta">
    <p>현재가: <strong class="price" data-current-price>₩<%= auction.currentPrice.toLocaleString('ko-KR') %></strong></p>
    <p>마감 예정: <time data-end-time datetime="<%= auction.endTime.toISOString() %>"><%= auction.endTime.toLocaleString('ko-KR') %></time></p>
    <p>총 입찰 수: <span data-bid-count><%= auction.bids.length %></span></p>
    <p
      class="winner-line <%= auction.status === 'CLOSED' ? '' : 'hidden' %>"
      data-winner-wrapper
    >
      낙찰자:
      <strong data-winner-name><%= auction.winnerNickname ? auction.winnerNickname : '낙찰자 없음' %></strong>
    </p>
    <p
      class="winner-line <%= auction.status === 'CLOSED' && auction.winningBidAmount ? '' : 'hidden' %>"
      data-winning-wrapper
    >
      낙찰가:
      <strong data-winning-amount>
        <% if (auction.winningBidAmount) { %>
        ₩<%= auction.winningBidAmount.toLocaleString('ko-KR') %>
        <% } %>
      </strong>
    </p>
    <a
      class="btn-secondary<%= downloadAllowed ? '' : ' is-disabled' %>"
      data-download-button
      data-download-available="<%= downloadAllowed %>"
      href="<%= downloadAllowed ? `/auctions/${auction.id}/download` : '#' %>"
      <%= downloadAllowed ? '' : 'aria-disabled="true"' %>
      >자료 다운로드</a
    >
    <p class="muted download-hint <%= downloadAllowed ? 'hidden' : '' %>" data-download-hint>
      경매 종료 후 판매자와 낙찰자만 자료를 내려받을 수 있습니다.
    </p>
    <p
      class="alert alert-success inline-alert <%= auction.status === 'CLOSED' && winnerView ? '' : 'hidden' %>"
      data-winner-message
    >
      축하합니다! 이 경매의 낙찰자입니다.
    </p>
    <p
      class="muted emphasis-message <%= auction.status === 'CLOSED' && sellerView && !auction.winnerNickname ? '' : 'hidden' %>"
      data-seller-no-bid-message
    >
      낙찰자가 없어 경매가 종료되었습니다.
    </p>
  </div>
  <section class="auction-description">
    <h3>설명</h3>
    <p><%= auction.description %></p>
  </section>
  <section class="auction-bids">
    <h3>입찰 내역</h3>
    <ul class="bid-list" data-bid-list>
      <% auction.bids.slice().reverse().forEach(function (bid) { %>
      <li>
        <span><%= bid.bidderNickname %></span>
        <span>₩<%= bid.amount.toLocaleString('ko-KR') %></span>
        <time><%= new Date(bid.createdAt).toLocaleString('ko-KR') %></time>
      </li>
      <% }); %>
    </ul>
  </section>

  <section class="bid-form">
    <h3>입찰하기</h3>
    <% if (bidAllowed) { %>
    <form action="/auctions/<%= auction.id %>/bids" method="post" class="form-inline" data-bid-form>
      <label>
        <input
          type="number"
          name="amount"
          min="<%= auction.currentPrice + 100 %>"
          step="100"
          placeholder="입찰 금액"
          required
        />
      </label>
      <button type="submit" class="btn-primary">입찰</button>
    </form>
    <% } else { %>
    <p class="muted">
      <% if (sellerView) { %>
      자신의 경매에는 입찰할 수 없습니다.
      <% } else if (auction.status === 'CLOSED') { %>
      이미 종료된 경매입니다.
      <% } else { %>
      참여할 수 없는 경매입니다.
      <% } %>
    </p>
    <% } %>
  </section>

  <section class="reputation-form">
    <h3>판매자 평가</h3>
    <% if (rateAllowed) { %>
    <form action="/auctions/<%= auction.id %>/rate" method="post" class="form-grid">
      <fieldset class="star-rating" data-star-rating>
        <legend class="sr-only">평점 선택</legend>
        <input type="hidden" name="score" value="" data-star-rating-value />
        <div class="star-rating__input" aria-hidden="true">
          <span class="star-rating__base">☆☆☆☆☆</span>
          <span class="star-rating__fill" data-star-rating-fill>★★★★★</span>
          <div class="star-rating__controls" role="radiogroup" aria-label="평점 선택">
            <% for (let star = 1; star <= 5; star++) { %>
            <div class="star-rating__star">
              <button
                type="button"
                class="star-rating__half star-rating__half--left"
                data-rating-value="<%= (star - 0.5).toFixed(1) %>"
                role="radio"
                aria-checked="false"
                aria-label="<%= (star - 0.5).toFixed(1) %>점 선택"
              ></button>
              <button
                type="button"
                class="star-rating__half star-rating__half--right"
                data-rating-value="<%= star.toFixed(1) %>"
                role="radio"
                aria-checked="false"
                aria-label="<%= star.toFixed(1) %>점 선택"
              ></button>
            </div>
            <% } %>
          </div>
        </div>
        <p class="star-rating__status" data-star-rating-status aria-live="polite">
          별을 선택해 평점을 입력해주세요. 반 개 단위 선택이 가능합니다.
        </p>
      </fieldset>
      <label>한 줄 평
        <textarea name="comment" rows="2" placeholder="거래 경험을 공유해주세요"></textarea>
      </label>
      <button type="submit" class="btn-secondary">평가 등록</button>
    </form>
    <% } else { %>
    <p class="muted">
      <% if (existingReview) { %>
      이미 이 경매에 대한 평가를 남기셨습니다.
      <% } else if (!bidderView) { %>
      입찰에 참여한 사용자만 경매 종료 후 평가를 남길 수 있습니다.
      <% } else if (auction.status !== 'CLOSED') { %>
      경매 종료 후에만 평가를 남길 수 있습니다.
      <% } else if (sellerView) { %>
      자신의 경매에는 평가를 남길 수 없습니다.
      <% } else { %>
      평가를 남길 수 있는 조건을 충족하지 않습니다.
      <% } %>
    </p>
    <% } %>
  </section>

  <section class="reputation-list">
    <h3>거래 후기</h3>
    <% if (Array.isArray(auction.reviews) && auction.reviews.length) { %>
    <ul class="review-list">
      <% auction.reviews.forEach(function (review) { %>
      <li class="review-item<%= existingReview && String(existingReview.bidderId) === String(review.bidderId) ? ' is-mine' : '' %>">
        <div class="review-header">
          <strong><%= review.bidderNickname %></strong>
          <span class="rating"><%= Number(review.score).toFixed(1) %>★</span>
          <time datetime="<%= new Date(review.createdAt).toISOString() %>">
            <%= new Date(review.createdAt).toLocaleString('ko-KR') %>
          </time>
        </div>
        <% if (review.comment) { %>
        <p class="review-comment"><%= review.comment %></p>
        <% } else { %>
        <p class="review-comment muted">한 줄 평이 등록되지 않았습니다.</p>
        <% } %>
      </li>
      <% }); %>
    </ul>
    <% } else { %>
    <p class="muted">아직 등록된 거래 후기가 없습니다.</p>
    <% } %>
  </section>

  <% if (activeUser && activeUser.isAdmin) { %>
  <section class="audit-log">
    <h3>MariaDB 거래 로그</h3>
    <table>
      <thead>
        <tr>
          <th>익명 닉네임</th>
          <th>입찰가</th>
          <th>기록 시각</th>
        </tr>
      </thead>
      <tbody>
        <% bidLogList.forEach(function (log) { %>
        <tr>
          <td><%= log.nickname %></td>
          <td>₩<%= Number(log.amount).toLocaleString('ko-KR') %></td>
          <td><%= new Date(log.created_at).toLocaleString('ko-KR') %></td>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </section>
  <% } %>
</section>
<%- include('../partials/footer') %>
